# CPOG Verifier Tool

This repository provides a command-line interface (CLI) to verify CNF instances using the CPOG verification pipeline. It supports verifying a single CNF file or processing multiple instances from a CSV file and annotating them with verification results. The tool integrates with external executables (`d4`, `cpog-gen`, `cpog-check`, `cadical`, and `drat-trim`) that must be placed in the `cpog_verifier/cpog` directory.

**Warning:**\
Both `d4` and `cpog-gen` are known to have memory leaks. Users should be cautious and set appropriate timeouts (`--thread-timeout`) and memory limits (`--memory-limit-gb`) to prevent the verifier from crashing. The tool is designed to handle interruptions gracefully and save partial results when possible.

## Before Running the Program

Make sure you already have fuzzer results generated by `SharpVelvet run_fuzzer`, which will produce the CSV file you feed into the verifier. The verifier is designed to integrate seamlessly with these results to provide model counting verification.

## Prerequisites

- A CSV file of fuzzer results generated by `SharpVelvet run_fuzzer`.
- A set of verification tool executables compiled and placed in `cpog_verifier/cpog`:
  - `d4`
  - `cpog-gen`
  - `cpog-check`
  - `cadical`
  - `drat-trim`

## Installing the Verification Tools

### d4

1. Clone the `d4` repository:
   ```bash
   git clone https://github.com/crillab/d4.git
   ```
1. Follow the build instructions in the `d4` repository (usually `make`).
1. After building, copy the `d4` executable into `cpog_verifier/cpog`.

### CaDiCaL

1. Clone the CaDiCaL repository:
   ```bash
   git clone https://github.com/arminbiere/cadical.git
   ```
1. Build CaDiCaL following the instructions (usually `./configure && make`).
1. Copy the `cadical` binary into `cpog_verifier/cpog`.

### drat-trim

1. Clone the `drat-trim` repository:\
   ```bash
   git clone https://github.com/marijnheule/drat-trim.git
   ```
1. Compile `drat-trim` (usually `make`).
1. Copy the `drat-trim` binary into `cpog_verifier/cpog`.

### cpog-gen and cpog-check

1. Clone the CPOG repository:
   ```bash
   git clone https://github.com/rebryant/cpog.git
   ```
1. Build `cpog-gen` and `cpog-check` following the instructions in the repository (usually `cargo build --release` if it's a Rust project).
1. Copy the resulting executables `cpog-gen` and `cpog-check` into `cpog_verifier/cpog`.

After these steps, the `cpog_verifier/cpog` directory should contain:

- `d4`
- `cadical`
- `drat-trim`
- `cpog-gen`
- `cpog-check`

Ensure all executables have the appropriate permissions (e.g., `chmod +x`).

## Usage

Navigate to the `cpog_verifier` directory. To run the tool:

```bash
python3 cli.py [OPTIONS]
```

### Arguments

- `--csv-path <FILE>`: Path to a CSV file containing multiple verification instances to process.\
  The CSV should have the following columns:

  - `instance_path`: Path to the CNF file.
  - `satisfiability`: E.g., "UNSATISFIABLE" or "SATISFIABLE".
  - `count_value`: The expected model count (if known).

- `--cnf-path <FILE>`: Path to a single CNF file for direct verification.

- `--verifier-dir <DIR>`: Directory containing verification tool binaries (default: `cpog_verifier/cpog`).

- `--output-dir <DIR>`: Directory to save generated CPOG files (if verifying a single CNF file).

- `--thread-timeout <SECONDS>`: Maximum execution time per verification thread (default: 3600 seconds).

- `--max-workers <N>`: Maximum number of parallel verification workers (default: 10).

- `--batch-size <N>`: Number of instances to process in a single batch. If omitted, all instances are processed in one batch.

- `--memory-limit-gb <FLOAT>`: Maximum allowed memory usage during batch processing (default: 4.0 GB).

You must provide either `--csv-path` or `--cnf-path`.

### Example: Verifying Multiple Instances from a CSV

```bash
python3 cli.py \
  --csv-path results.csv \
  --thread-timeout 300 \
  --max-workers 4 \
  --memory-limit-gb 2.0
```

This will process `results.csv`, verify each instance using the tools in `cpog_verifier/cpog`, and produce an output CSV (`results_with_cpog.csv`) with additional verification columns.

### Example: Verifying a Single CNF Instance

```bash
python3 cli.py \
  --cnf-path instance.cnf \
  --output-dir verified_cpogs \
  --thread-timeout 300
```

This will verify the single CNF file `instance.cnf` and, if successful, produce a corresponding `.cpog` file in `verified_cpogs`.

## Notes on Performance and Stability

- **Memory Leaks**: As mentioned, `d4` and `cpog-gen` have known memory leaks. Always set `--thread-timeout` and `--memory-limit-gb` values that align with your systemâ€™s capabilities. If memory usage grows too large, the verifier will halt processing and mark remaining instances as "OUT OF MEMORY" while still saving partial results.
- **Partial Results**: If the verification is interrupted (e.g., by `Ctrl+C`), the tool will attempt to save partial results from the processed instances.

## Using the Verifier in a Jupyter Notebook

In addition to the CLI usage, you can also integrate the verification process directly into a Jupyter Notebook environment. By importing and calling the `verify_with_cpog()` function from `cpog_verifier.utils`, you can run the verification and process results programmatically. For example:

```python
from result_processor.utils import process_results
from cpog_verifier.utils import verify_with_cpog
import pandas as pd

# Load the CSV with fuzzer results
df = process_results("results.csv")

# Run verification
results_df = verify_with_cpog(
    df,
    thread_timeout=300,
    max_workers=4,
    memory_limit_gb=2.0
)

# Use results_df in analysis
```

This approach allows you to incorporate verification into your data analysis or model evaluation workflow directly in a Jupyter environment.
